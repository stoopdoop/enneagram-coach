<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Enneagram Coach</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .question {
            margin-bottom: 25px;
            padding: 20px;
            border-left: 4px solid #667eea;
            background: #f8f9ff;
            border-radius: 8px;
        }
        .question h3 {
            margin-top: 0;
            color: #4a5568;
        }
        .options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        .option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        .option:hover {
            background-color: #e2e8f0;
        }
        .option input[type="radio"] {
            margin-bottom: 5px;
            transform: scale(1.2);
        }
        .option label {
            font-size: 12px;
            text-align: center;
            cursor: pointer;
        }
        .progress {
            width: 100%;
            height: 20px;
            background-color: #e2e8f0;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .results {
            display: none;
            text-align: center;
        }
        .type-result {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
        }
        .chat-container {
            margin-top: 30px;
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 20px;
            background: #f8f9ff;
        }
        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
        }
        .user-message {
            background: #667eea;
            color: white;
            margin-left: 20%;
        }
        .ai-message {
            background: #e2e8f0;
            color: #333;
            margin-right: 20%;
        }
        .chat-input {
            display: flex;
            gap: 10px;
        }
        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
        }
        .hidden {
            display: none;
        }
        .type-option {
            background: #f8f9ff;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .type-option:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .type-option strong {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
        }
        .type-option p {
            margin: 0;
            font-size: 14px;
            opacity: 0.8;
        }
        .support-notice {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }
        .support-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .support-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        .support-text {
            flex: 1;
        }
        .support-text strong {
            color: #4a5568;
            display: block;
            margin-bottom: 5px;
        }
        .support-text p {
            margin: 0;
            font-size: 14px;
            color: #6b7280;
        }
        .support-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .support-btn, .support-btn-custom {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .support-btn:hover, .support-btn-custom:hover {
            background: #5a67d8;
        }
        .support-btn-custom {
            background: #764ba2;
        }
        .close-support {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #9ca3af;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-support:hover {
            color: #6b7280;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

@media (max-width: 600px) {
    .container {
        padding: 15px;
        margin: 10px;
    }
    
    .type-option {
        font-size: 14px;
        padding: 15px;
    }
    
    .options {
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .option {
        margin: 5px;
        min-width: 60px;
    }
    
    .option label {
        font-size: 11px;
    }
    
    .chat-input {
        flex-direction: column;
    }
    
    .chat-input input {
        margin-bottom: 10px;
    }
    
    h1 {
        font-size: 24px;
    }
    
    h2 {
        font-size: 20px;
    }
}

        @media (min-width: 601px) {
    div[onclick="startAssessment()"]:hover,
    div[onclick="showTypeSelector()"]:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    }
}
        
    </style>
</head>
<body>
    <div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 9999;">
        <div style="text-align: center; color: white;">
            <h2>üåü Loading AI Enneagram Coach...</h2>
            <div style="margin-top: 20px; font-size: 48px;">‚è≥</div>
        </div>
    </div>
    <div class="container">
        
        <h1 style="text-align: center; color: #4a5568;">üåü AI Enneagram Coach</h1>
        
        <div id="startPage">
            <div style="text-align: center; margin: 40px 0;">
                <h2>Welcome to Your Personal Enneagram Coach</h2>
                <p style="font-size: 18px; margin: 30px 0; color: #4a5568;">Choose how you'd like to begin your journey:</p>
                
                <div style="display: flex; gap: 30px; justify-content: center; flex-wrap: wrap; margin: 40px 0;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; max-width: 300px; cursor: pointer; transition: transform 0.3s;" onclick="startAssessment()">
                        <h3 style="margin-top: 0;">üìù Take the Assessment</h3>
                        <p>Discover your Enneagram type with our comprehensive 108-question assessment</p>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin-top: 15px;">
                            <strong>Perfect if you're new to Enneagram or want to confirm your type</strong>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); color: white; padding: 30px; border-radius: 15px; max-width: 300px; cursor: pointer; transition: transform 0.3s;" onclick="showTypeSelector()">
                        <h3 style="margin-top: 0;">üí¨ I Know My Type</h3>
                        <p>Skip to coaching if you already know your Enneagram type</p>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; margin-top: 15px;">
                            <strong>Jump straight to personalized coaching and insights</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="typeSelector" class="hidden">
            <h2>Select Your Enneagram Type</h2>
            <p>Choose your type to start chatting with your personalized AI coach:</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 30px 0;">
                <div class="type-option" onclick="selectType(1)">
                    <strong>Type 1 - The Perfectionist</strong>
                    <p>Principled, purposeful, self-controlled, and perfectionistic</p>
                </div>
                <div class="type-option" onclick="selectType(2)">
                    <strong>Type 2 - The Helper</strong>
                    <p>Caring, interpersonal, demonstrative, generous, and people-pleasing</p>
                </div>
                <div class="type-option" onclick="selectType(3)">
                    <strong>Type 3 - The Achiever</strong>
                    <p>Self-assured, attractive, charming, ambitious, competent, and energetic</p>
                </div>
                <div class="type-option" onclick="selectType(4)">
                    <strong>Type 4 - The Individualist</strong>
                    <p>Self-aware, sensitive, reserved, emotionally honest, creative, and personal</p>
                </div>
                <div class="type-option" onclick="selectType(5)">
                    <strong>Type 5 - The Investigator</strong>
                    <p>Intense, cerebral, perceptive, innovative, secretive, and isolated</p>
                </div>
                <div class="type-option" onclick="selectType(6)">
                    <strong>Type 6 - The Loyalist</strong>
                    <p>Reliable, hard-working, responsible, anxious, and suspicious</p>
                </div>
                <div class="type-option" onclick="selectType(7)">
                    <strong>Type 7 - The Enthusiast</strong>
                    <p>Busy, fun-loving, spontaneous, versatile, distractible, and scattered</p>
                </div>
                <div class="type-option" onclick="selectType(8)">
                    <strong>Type 8 - The Challenger</strong>
                    <p>Self-confident, strong, assertive, protective, resourceful, straight-talking, and decisive</p>
                </div>
                <div class="type-option" onclick="selectType(9)">
                    <strong>Type 9 - The Peacemaker</strong>
                    <p>Accepting, trusting, stable, creative, optimistic, and supportive</p>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="backToStart()" style="background: #6c757d;">‚Üê Back to Start</button>
            </div>
            
        </div>
        
        <div id="assessment" class="hidden">
            <h2>Discover Your Enneagram Type</h2>
            <p>Answer these questions honestly based on how you generally think, feel, and behave. There are no right or wrong answers.</p>
            
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div id="progressText">Question 1 of 108</div>
            
            <div id="questionContainer"></div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" id="nextBtn" onclick="nextQuestion()">Next Question</button>
                <button class="btn" id="prevBtn" onclick="previousQuestion()" style="display: none; background: #6c757d; margin-left: 10px;">‚Üê Previous</button>
                <button class="btn hidden" id="resultsBtn" onclick="showResults()">Get My Results</button>
                <button class="btn" onclick="backToStart()" style="background: #6c757d; margin-left: 10px;">‚Üê Back to Start</button>
                <button class="btn" onclick="startOver()" style="background: #dc3545; margin-left: 10px;">Start Over</button>
            </div>
        </div>

        <div id="results" class="results">
            <div class="type-result">
                <h2>Your Enneagram Type: <span id="resultType"></span></h2>
                <h3 id="resultTitle"></h3>
                <p id="resultDescription"></p>
            </div>
            
            <div class="chat-container">
                <h3>üí¨ Chat with Your AI Enneagram Coach</h3>
                <p><strong>Disclaimer:</strong> This AI coach provides educational insights about Enneagram types and personal development. It is not a substitute for professional counseling, therapy, or medical advice. For clinical mental health support, please consult a licensed professional.</p>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai-message">
                        Hello! I'm your AI Enneagram Coach. I'm here to help you understand your type and explore personal growth opportunities. What would you like to know about your Enneagram results?
                    </div>
                </div>
                
                <div class="chat-input">
                    <input type="text" id="userInput" placeholder="Ask me about your Enneagram type..." onkeypress="handleKeyPress(event)">
                    <button class="btn" onclick="sendMessage()">Send</button>
                </div>
                
                <div id="supportNotice" class="support-notice hidden">
                    <div class="support-content">
                        <span class="support-icon">‚òï</span>
                        <div class="support-text">
                            <strong>Enjoying your AI coaching session?</strong>
                            <p>Each response costs me to generate. If this is helpful, a small contribution keeps the service running!</p>
                        </div>
                        <div class="support-buttons">
                            <button class="support-btn" onclick="openDonation(1)">$1</button>
                            <button class="support-btn" onclick="openDonation(5)">$5</button>
                            <button class="support-btn" onclick="openDonation(10)">$10</button>
                            <button class="support-btn-custom" onclick="openCustomDonation()">Other</button>
                        </div>
                        <button class="close-support" onclick="closeSupportNotice()">√ó</button>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn" onclick="exportConversation()" style="background: #6c757d; font-size: 14px; padding: 8px 16px;">üì• Export Conversation</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const questions = [
            // Type 1 Questions
            "I have a strong inner critic that points out what's wrong or could be improved.",
            "I often feel frustrated when things are not done correctly or efficiently.",
            "I believe there's a right way and wrong way to do most things.",
            "I tend to be organized and like to plan ahead.",
            "I often notice errors and mistakes that others miss.",
            "I feel responsible for improving situations and fixing problems.",
            "I can be quite critical of myself and others.",
            "I have high standards and expect excellence.",
            "I often feel angry about injustice or incompetence.",
            "I prefer structure and clear guidelines.",
            "I believe hard work and discipline lead to success.",
            "I often postpone fun until important work is completed.",
            
            // Type 2 Questions
            "I often put others' needs before my own.",
            "I have a strong desire to be helpful and needed.",
            "I'm very sensitive to others' emotions and moods.",
            "I often know what others need before they ask.",
            "I sometimes feel unappreciated despite my efforts to help.",
            "I find it difficult to ask for help when I need it.",
            "I often give advice even when not asked.",
            "I feel good about myself when I'm helping others.",
            "I sometimes feel resentful when my help isn't acknowledged.",
            "I have trouble saying no to requests for help.",
            "I often focus on relationships and connections.",
            "I sometimes neglect my own needs while caring for others.",
            
            // Type 3 Questions
            "I'm very goal-oriented and focused on achieving success.",
            "I often adapt my image to fit what others expect or admire.",
            "I'm competitive and like to win or be the best.",
            "I measure my worth by my accomplishments.",
            "I'm usually very busy and have many projects going.",
            "I often focus on efficiency and getting results.",
            "I sometimes cut corners to achieve my goals faster.",
            "I'm good at promoting myself and my achievements.",
            "I often compare myself to others' success.",
            "I can become impatient with inefficiency or slowness.",
            "I like to be recognized for my achievements.",
            "I sometimes struggle to slow down and relax.",
            
            // Type 4 Questions
            "I often feel different from other people.",
            "I have intense emotions and deep feelings.",
            "I'm drawn to what's missing or unavailable.",
            "I often feel misunderstood by others.",
            "I have a rich inner life and vivid imagination.",
            "I'm attracted to beauty, art, and aesthetic experiences.",
            "I sometimes feel envious of what others have.",
            "I often focus on what's lacking in my life.",
            "I can be quite moody and emotionally reactive.",
            "I value authenticity and being true to myself.",
            "I often feel nostalgic or melancholic.",
            "I sometimes feel like an outsider looking in.",
            
            // Type 5 Questions
            "I need plenty of alone time to recharge and think.",
            "I prefer to observe before participating.",
            "I often feel drained by too much social interaction.",
            "I like to understand how things work.",
            "I tend to be private and keep my thoughts to myself.",
            "I often feel overwhelmed by others' emotional demands.",
            "I prefer to be self-reliant and independent.",
            "I often withdraw when feeling pressured or invaded.",
            "I like to have expertise and knowledge in my areas of interest.",
            "I sometimes feel like I don't have enough energy for everything.",
            "I prefer written communication over verbal sometimes.",
            "I often need time to process before responding.",
            
            // Type 6 Questions
            "I often think about potential problems and worst-case scenarios.",
            "I value loyalty and commitment in relationships.",
            "I sometimes doubt my own judgment and seek reassurance.",
            "I often look to authorities or experts for guidance.",
            "I can be quite anxious and worry about the future.",
            "I'm good at spotting potential risks or dangers.",
            "I sometimes question people's motives and intentions.",
            "I feel more secure when I have backup plans.",
            "I often seek safety and security in my decisions.",
            "I can be both trusting and suspicious of others.",
            "I sometimes have trouble making decisions.",
            "I often feel responsible for others' safety and well-being.",
            
            // Type 7 Questions
            "I like to keep my options open and avoid commitment.",
            "I often have many ideas and projects going at once.",
            "I prefer to focus on positive possibilities rather than problems.",
            "I get bored easily and like variety and stimulation.",
            "I often plan fun activities and future adventures.",
            "I tend to be optimistic and enthusiastic.",
            "I sometimes avoid dealing with negative emotions.",
            "I like to try new experiences and explore different options.",
            "I often reframe negative situations in a positive light.",
            "I can become restless when stuck in routine.",
            "I often entertain others with stories and humor.",
            "I sometimes have trouble finishing what I start.",
            
            // Type 8 Questions
            "I'm not afraid to confront others when necessary.",
            "I often take charge in group situations.",
            "I have strong opinions and am not easily swayed.",
            "I protect and stand up for underdogs or those I care about.",
            "I prefer direct, honest communication even if it's uncomfortable.",
            "I often challenge authority when I disagree.",
            "I have a lot of energy and intensity.",
            "I sometimes come across as intimidating without meaning to.",
            "I believe in justice and fairness.",
            "I often act quickly and decisively.",
            "I sometimes have trouble showing vulnerability.",
            "I prefer to be in control of my environment and circumstances.",
            
            // Type 9 Questions
            "I often go along with others to avoid conflict.",
            "I can see multiple perspectives in most situations.",
            "I sometimes have trouble making decisions or setting priorities.",
            "I prefer harmony and peace in my relationships.",
            "I often procrastinate on important tasks.",
            "I sometimes lose track of my own wants and needs.",
            "I'm a good mediator and can help others resolve conflicts.",
            "I sometimes feel overlooked or forgotten.",
            "I often merge with others' agendas instead of pursuing my own.",
            "I can be quite stubborn when pushed too hard.",
            "I prefer routine and familiar environments.",
            "I sometimes have trouble getting motivated or energized."
        ];

        let currentQuestion = 0;
        let answers = new Array(108).fill(0);
        let userType = null;
        let messageCount = 0;
        let supportNoticeShown = false;

let conversationHistory = [];

function saveAssessmentState() {
    const state = {
        currentQuestion,
        answers,
        userType
    };
    sessionStorage.setItem('enneagramAssessment', JSON.stringify(state));
}

function loadAssessmentState() {
    const saved = sessionStorage.getItem('enneagramAssessment');
    if (saved) {
        const state = JSON.parse(saved);
        currentQuestion = state.currentQuestion;
        answers = state.answers;
        userType = state.userType;
        return true;
    }
    return false;
}
        
        function startAssessment() {
    document.getElementById('startPage').classList.add('hidden');
    document.getElementById('assessment').classList.remove('hidden');
    
    // Check if there's saved progress
    if (loadAssessmentState() && currentQuestion > 0) {
        if (confirm('You have saved progress. Would you like to continue where you left off?')) {
            loadQuestion();
        } else {
            currentQuestion = 0;
            answers = new Array(108).fill(0);
            sessionStorage.removeItem('enneagramAssessment');
            loadQuestion();
        }
    } else {
        loadQuestion();
    }
}

        function showTypeSelector() {
            document.getElementById('startPage').classList.add('hidden');
            document.getElementById('typeSelector').classList.remove('hidden');
        }

        function selectType(typeNumber) {
            userType = typeNumber;
            showChatInterface();
        }

        function backToStart() {
            // Hide all sections
            document.getElementById('assessment').classList.add('hidden');
            document.getElementById('typeSelector').classList.add('hidden');
            document.getElementById('results').style.display = 'none';
            
            // Show start page
            document.getElementById('startPage').classList.remove('hidden');
            
            // Reset assessment if needed
            currentQuestion = 0;
            answers = new Array(108).fill(0);
            userType = null;
        }
        function startOver() {
    if (confirm('Are you sure you want to start over? This will reset all your answers.')) {
        currentQuestion = 0;
        answers = new Array(108).fill(0);
        userType = null;
        messageCount = 0;
        supportNoticeShown = false;
        conversationHistory = [];
        
        // Clear any saved state
        sessionStorage.removeItem('enneagramAssessment');
        
        // Reset UI
        document.getElementById('assessment').classList.add('hidden');
        document.getElementById('results').style.display = 'none';
        document.getElementById('typeSelector').classList.add('hidden');
        document.getElementById('startPage').classList.remove('hidden');
        
        // Reset buttons
        document.getElementById('nextBtn').classList.remove('hidden');
        document.getElementById('resultsBtn').classList.add('hidden');
    }
}

        function showChatInterface() {
            const typeInfo = {
                1: {
                    title: "The Perfectionist",
                    description: "You are principled, purposeful, self-controlled, and perfectionistic. You strive to be good and right, and to improve everything around you. You are well-organized, orderly, and fastidious, trying to maintain high standards, but can slip into being critical and perfectionistic."
                },
                2: {
                    title: "The Helper",
                    description: "You are caring, interpersonal, demonstrative, generous, and people-pleasing. You are empathetic, sincere, and warm-hearted. You are friendly, generous, and self-sacrificing, but can also be sentimental, flattering, and people-pleasing."
                },
                3: {
                    title: "The Achiever",
                    description: "You are self-assured, attractive, charming, ambitious, competent, and energetic. You are adaptable, excelling, driven, and image-conscious. You can also be competitive, workaholic, and overly concerned with your image and what others think of you."
                },
                4: {
                    title: "The Individualist",
                    description: "You are self-aware, sensitive, and reserved. You are emotionally honest, creative, and personal, but can also be moody and self-conscious. You may feel vulnerable and defective, but are also inspired and highly creative."
                },
                5: {
                    title: "The Investigator",
                    description: "You are intense, cerebral, perceptive, innovative, secretive, and isolated. You are able to concentrate and focus on developing complex ideas and skills. Independent and inventive, you can become preoccupied with your thoughts and imaginary constructs."
                },
                6: {
                    title: "The Loyalist",
                    description: "You are reliable, hard-working, responsible, anxious, and suspicious. You are committed, security-oriented, engaging, responsible, and anxious. You can be excellent troubleshooters and are loyal and faithful, but can also become defensive and evasive."
                },
                7: {
                    title: "The Enthusiast",
                    description: "You are busy, fun-loving, spontaneous, versatile, distractible, and scattered. You are extroverted, optimistic, versatile, and spontaneous. You are playful, high-spirited, and practical, but can become overextended, scattered, and undisciplined."
                },
                8: {
                    title: "The Challenger",
                    description: "You are self-confident, strong, assertive, protective, resourceful, straight-talking, and decisive. You can take charge and make things happen. You can be heroic and inspiring, but can also be combative and intimidating."
                },
                9: {
                    title: "The Peacemaker",
                    description: "You are accepting, trusting, stable, creative, optimistic, and supportive. You are usually grounded, supportive, and often creative, but can be too willing to go along with others to keep the peace. You desire harmony and can be complacent and minimize problems."
                }
            };
            
            // Hide other sections
            document.getElementById('startPage').classList.add('hidden');
            document.getElementById('typeSelector').classList.add('hidden');
            document.getElementById('assessment').classList.add('hidden');
            
            // Update results section with selected type
            document.getElementById('resultType').textContent = `Type ${userType}`;
            document.getElementById('resultTitle').textContent = typeInfo[userType].title;
            document.getElementById('resultDescription').textContent = typeInfo[userType].description;
            
            // Show results/chat section
            document.getElementById('results').style.display = 'block';
            
            // Clear any existing chat messages except the initial one
            const chatContainer = document.getElementById('chatMessages');
            chatContainer.innerHTML = `
                <div class="message ai-message">
                    Hello! I'm your AI Enneagram Coach. I can see you're a Type ${userType} - ${typeInfo[userType].title}. I'm here to help you understand your type and explore personal growth opportunities. What would you like to know about your Enneagram type?
                </div>
            `;
        }

        function loadQuestion() {
            const container = document.getElementById('questionContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            container.innerHTML = `
                <div class="question">
                    <h3>Question ${currentQuestion + 1}</h3>
                    <p>${questions[currentQuestion]}</p>
                    <div class="options">
                        <div class="option">
                            <input type="radio" name="q${currentQuestion}" value="1" id="q${currentQuestion}_1">
                            <label for="q${currentQuestion}_1">Strongly<br>Disagree</label>
                        </div>
                        <div class="option">
                            <input type="radio" name="q${currentQuestion}" value="2" id="q${currentQuestion}_2">
                            <label for="q${currentQuestion}_2">Disagree</label>
                        </div>
                        <div class="option">
                            <input type="radio" name="q${currentQuestion}" value="3" id="q${currentQuestion}_3">
                            <label for="q${currentQuestion}_3">Neutral</label>
                        </div>
                        <div class="option">
                            <input type="radio" name="q${currentQuestion}" value="4" id="q${currentQuestion}_4">
                            <label for="q${currentQuestion}_4">Agree</label>
                        </div>
                        <div class="option">
                            <input type="radio" name="q${currentQuestion}" value="5" id="q${currentQuestion}_5">
                            <label for="q${currentQuestion}_5">Strongly<br>Agree</label>
                        </div>
                    </div>
                </div>
            `;
            
            progressBar.style.width = ((currentQuestion + 1) / 108) * 100 + '%';
            progressText.textContent = `Question ${currentQuestion + 1} of 108`;
            
            // Restore previous answer if exists
            if (answers[currentQuestion] > 0) {
                document.getElementById(`q${currentQuestion}_${answers[currentQuestion]}`).checked = true;
            }
            // Show/hide previous button
document.getElementById('prevBtn').style.display = currentQuestion === 0 ? 'none' : 'inline-block';
        }
        
        function nextQuestion() {
            const selected = document.querySelector(`input[name="q${currentQuestion}"]:checked`);
            if (!selected) {
                alert('Please select an answer before continuing.');
                return;
            }
            
            answers[currentQuestion] = parseInt(selected.value);

            saveAssessmentState();
            
            if (currentQuestion < 107) {
                currentQuestion++;
                loadQuestion();
            } else {
                document.getElementById('nextBtn').classList.add('hidden');
                document.getElementById('resultsBtn').classList.remove('hidden');
            }
        }

function previousQuestion() {
    if (currentQuestion > 0) {
        currentQuestion--;
        loadQuestion();
        document.getElementById('resultsBtn').classList.add('hidden');
        document.getElementById('nextBtn').classList.remove('hidden');
    }
    saveAssessmentState();
}
        
        function calculateType() {
            const typeScores = new Array(9).fill(0);
            
            // Calculate scores for each type (12 questions each)
            for (let type = 0; type < 9; type++) {
                for (let q = 0; q < 12; q++) {
                    const questionIndex = type * 12 + q;
                    typeScores[type] += answers[questionIndex];
                }
            }
            
            // Find the type with highest score
            let maxScore = 0;
            let resultType = 1;
            for (let i = 0; i < 9; i++) {
                if (typeScores[i] > maxScore) {
                    maxScore = typeScores[i];
                    resultType = i + 1;
                }
            }
            
            return resultType;
        }

        function showResults() {
            userType = calculateType();
            showChatInterface();
        }

function sendMessage() {
    const input = document.getElementById('userInput');
    const message = input.value.trim();
    if (!message) return;
    
    // Disable input while processing
    input.disabled = true;
    const sendBtn = input.nextElementSibling;
    sendBtn.disabled = true;
    const originalText = sendBtn.textContent;
    sendBtn.textContent = 'Sending...';
    
    // Store in conversation history
    conversationHistory.push({role: 'user', message: message});
    
    addMessage(message, 'user');
    input.value = '';
    messageCount++;
    
    setTimeout(() => {
        const response = generateResponse(message);
        conversationHistory.push({role: 'ai', message: response});
        addMessage(response, 'ai');
        
        // Re-enable input
        input.disabled = false;
        sendBtn.disabled = false;
        sendBtn.textContent = originalText;
        input.focus();
        
        if (messageCount >= 3 && userType && !supportNoticeShown) {
            setTimeout(() => showSupportNotice(), 2000);
        }
    }, 1000);
}

        function showSupportNotice() {
            if (!supportNoticeShown) {
                document.getElementById('supportNotice').classList.remove('hidden');
                supportNoticeShown = true;
            }
        }

        function closeSupportNotice() {
            document.getElementById('supportNotice').classList.add('hidden');
        }

        function openDonation(amount) {
    const buyMeCoffeeLink = `https://www.buymeacoffee.com/enneagramaicoach`;
    const paypalLink = `https://www.paypal.com/donate/?business=YEPMU72J6H84Q&no_recurring=0&item_name=Enneagram+AI+Coach&currency_code=USD&amount=${amount}`;
    
    const options = `
        <div style="padding: 25px; text-align: center;">
            <h3 style="color: #4a5568; margin-bottom: 10px;">Thank you for your support! üôè</h3>
            <p style="color: #6b7280; margin-bottom: 20px;">Your contribution helps keep this AI coaching service running!</p>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin: 20px 0;">
                <a href="${buyMeCoffeeLink}" target="_blank" style="display: inline-block; background: linear-gradient(135deg, #ffdd00 0%, #ffaa00 100%); color: #333; padding: 12px 20px; text-decoration: none; border-radius: 10px; font-weight: bold; box-shadow: 0 4px 15px rgba(255, 221, 0, 0.3); transition: transform 0.2s; min-width: 140px;">
                    ‚òï Buy Me a Coffee<br><small>($${amount})</small>
                </a>
                <a href="${paypalLink}" target="_blank" style="display: inline-block; background: linear-gradient(135deg, #0070ba 0%, #003087 100%); color: white; padding: 12px 20px; text-decoration: none; border-radius: 10px; font-weight: bold; box-shadow: 0 4px 15px rgba(0, 112, 186, 0.3); transition: transform 0.2s; min-width: 140px;">
                    üí≥ PayPal<br><small>($${amount})</small>
                </a>
            </div>
            <p style="font-size: 13px; color: #9ca3af; margin-top: 15px;">
                Every contribution, no matter the size, is deeply appreciated!<br>
                <strong>Choose your preferred payment method above</strong>
            </p>
        </div>
    `;
    
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:1000;';
    modal.innerHTML = `
        <div style="background:white;border-radius:15px;max-width:450px;margin:20px;box-shadow:0 10px 30px rgba(0,0,0,0.3);">
            ${options}
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="background:#e5e7eb;border:none;padding:10px 25px;border-radius:8px;margin:10px;cursor:pointer;color:#374151;font-size:14px;">
                Close
            </button>
        </div>
    `;
    document.body.appendChild(modal);
    closeSupportNotice();
}

        function openCustomDonation() {
            const amount = prompt("Enter any amount you'd like to contribute (e.g., 3.50):");
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                openDonation(parseFloat(amount));
            }
        }

        function addMessage(message, sender) {
            const container = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            messageDiv.textContent = message;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

function exportConversation() {
    if (conversationHistory.length === 0) {
        alert('No conversation to export yet!');
        return;
    }
    
    const typeNames = {
        1: "The Perfectionist",
        2: "The Helper",
        3: "The Achiever",
        4: "The Individualist",
        5: "The Investigator",
        6: "The Loyalist",
        7: "The Enthusiast",
        8: "The Challenger",
        9: "The Peacemaker"
    };
    
    let text = `Enneagram AI Coach Conversation\n`;
    text += `Type ${userType} - ${typeNames[userType]}\n`;
    text += `Date: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}\n`;
    text += `${'='.repeat(50)}\n\n`;
    
    conversationHistory.forEach(entry => {
        text += `${entry.role === 'user' ? 'You' : 'AI Coach'}: ${entry.message}\n\n`;
    });
    
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `enneagram-coaching-type${userType}-${new Date().getTime()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
        
        function generateResponse(userMessage) {
    // Ensure user has a type
    if (!userType) {
        return "I'd be happy to help! Please make sure you've completed the assessment or selected your type first.";
    }
    
    // Get type info for context
    const typeInfo = {
        1: "The Perfectionist - principled, purposeful, self-controlled, and perfectionistic",
        2: "The Helper - caring, interpersonal, demonstrative, generous, and people-pleasing", 
        3: "The Achiever - self-assured, attractive, charming, ambitious, competent, and energetic",
        4: "The Individualist - self-aware, sensitive, reserved, emotionally honest, creative, and personal",
        5: "The Investigator - intense, cerebral, perceptive, innovative, secretive, and isolated",
        6: "The Loyalist - reliable, hard-working, responsible, anxious, and suspicious",
        7: "The Enthusiast - busy, fun-loving, spontaneous, versatile, distractible, and scattered",
        8: "The Challenger - self-confident, strong, assertive, protective, resourceful, straight-talking, and decisive",
        9: "The Peacemaker - accepting, trusting, stable, creative, optimistic, and supportive"
    };
    
    // Create a comprehensive prompt for Claude
    const prompt = `You are an expert Enneagram coach having a conversation with someone who is Type ${userType} (${typeInfo[userType]}). 

Their question/message: "${userMessage}"

Please respond as a knowledgeable, empathetic Enneagram coach. Consider:
- Their Type ${userType} perspective, motivations, and typical challenges
- How their type might relate to any other types mentioned
- Practical, actionable insights for their personal growth
- Relationship dynamics if they're asking about interactions with others
- Be conversational, supportive, and insightful

Respond directly to what they're asking about, whether it's relationships, work, personal growth, type comparisons, or any other Enneagram-related topic.`;

    // For now, return a response that acknowledges this is meant to be Claude
    // In a real implementation, this would connect to Claude's API
    return generateEnneagramResponse(userMessage, userType);
}

function generateEnneagramResponse(message, userType) {
    const typeTraits = {
        1: "As a Type 1, you value excellence, improvement, and doing things right",
        2: "As a Type 2, you're naturally caring and attentive to others' needs",
        3: "As a Type 3, you're driven, adaptable, and focused on achievement",
        4: "As a Type 4, you value authenticity, depth, and meaningful expression",
        5: "As a Type 5, you appreciate knowledge, independence, and understanding",
        6: "As a Type 6, you value security, loyalty, and careful planning",
        7: "As a Type 7, you love possibilities, variety, and positive experiences",
        8: "As a Type 8, you're naturally strong, direct, and protective of others",
        9: "As a Type 9, you bring peace, understanding, and harmony to situations"
    };

    // Instead of keyword matching, provide contextual, conversational responses
    return generateContextualResponse(message, userType, typeTraits[userType]);
}

function generateContextualResponse(message, userType, typeTrait) {
    const lowerMessage = message.toLowerCase();
    const tone = detectEmotionalTone(message);
    const depth = getResponseDepth();
    const scenario = getScenarioExample(userType, 'general');
    
    // Emotional tone prefixes
    const tonePrefix = tone === 'frustrated' ? "I can hear the frustration in your message. " : 
                       tone === 'sad' ? "It sounds like you're going through a difficult time. " : 
                       tone === 'positive' ? "I love the energy in your message! " :
                       tone === 'seeking' ? "I appreciate you reaching out for understanding. " : "";
    
    // More natural, varied responses that feel like talking to Claude
    const responses = [
        `${tonePrefix}${typeTrait}. That's such an insightful question. From your Type ${userType} perspective, you likely experience this through the lens of ${getTypeLens(userType)}. 

What I find fascinating about your question is how it touches on ${getThemeFromMessage(message, userType)}. This is something many Type ${userType}s wrestle with.

${scenario ? `It might be like ${scenario}.` : ''}

Tell me more about what's driving this question for you - I'd love to understand the specific context you're navigating.`,

        `${tonePrefix}${typeTrait}. This really resonates with the Type ${userType} experience. You're touching on something that goes to the heart of how your type moves through the world.

${getPersonalizedInsight(message, userType)}

${depth === 'deep' ? getIntegrationDirection(userType) : ''}

I'm curious - how has this been showing up in your life lately? Understanding your specific situation will help me offer more targeted insights.`,

        `${tonePrefix}What a thoughtful question. ${typeTrait}, and what you're describing connects to some core aspects of your type's journey.

From my experience working with Type ${userType}s, this often relates to ${getTypicalChallenge(userType)}. But every person's experience is unique.

${scenario ? `Many Type ${userType}s tell me about situations like: ${scenario}` : ''}

Can you share more about what prompted this question? I'd love to explore this with you in a way that's most helpful for your specific situation.`
    ];
    
    // For deeper conversations, add conversation starters
    if (depth === 'deep' && Math.random() > 0.5) {
        const starters = getConversationStarters(userType);
        const randomStarter = starters[Math.floor(Math.random() * starters.length)];
        if (randomStarter) {
            responses[0] += `\n\nYou might also find it helpful to explore: ${randomStarter}`;
        }
    }
    
    // Randomly select a response style to feel more natural
    return responses[Math.floor(Math.random() * responses.length)];
}

function getTypeLens(type) {
    const lenses = {
        1: "your desire for improvement and getting things right",
        2: "your focus on relationships and helping others",
        3: "your drive for success and achievement",
        4: "your search for authenticity and meaning",
        5: "your need to understand and maintain your energy",
        6: "your desire for security and loyalty",
        7: "your love of possibilities and keeping things positive",
        8: "your focus on justice and protecting others",
        9: "your desire for harmony and peace"
    };
    return lenses[type];
}

function getThemeFromMessage(message, userType) {
    // Analyze the message more holistically rather than keyword matching
    const themes = {
        1: "the balance between high standards and self-compassion",
        2: "the dance between caring for others and honoring your own needs",
        3: "the relationship between achieving goals and staying true to yourself",
        4: "the tension between feeling different and finding your place in the world",
        5: "the balance between understanding deeply and engaging with life",
        6: "the interplay between seeking security and trusting yourself",
        7: "the challenge of embracing both joy and difficult emotions",
        8: "the balance between strength and vulnerability",
        9: "the journey between keeping peace and advocating for yourself"
    };
    return themes[userType];
}

function getPersonalizedInsight(message, userType) {
    const insights = {
        1: "Your perfectionist nature is both a gift and sometimes a burden. The key is learning when 'good enough' truly is perfect.",
        2: "Your caring heart is beautiful, but remember that you can't pour from an empty cup. Your needs matter too.",
        3: "Your ability to adapt and achieve is remarkable. The growth edge is staying connected to what truly fulfills you.",
        4: "Your emotional depth and authenticity are gifts to the world. Sometimes the 'missing piece' is accepting what's already here.",
        5: "Your thoughtful, analytical approach offers unique insights. The growth often comes in sharing that wisdom with others.",
        6: "Your loyalty and careful thinking are valuable. Learning to trust your own judgment is often the next step.",
        7: "Your optimism and enthusiasm bring light to others. Sometimes the deepest growth comes from sitting with the difficult feelings too.",
        8: "Your strength and directness create positive change. The vulnerability underneath that strength is equally powerful.",
        9: "Your peaceful presence is a gift. Your voice and preferences matter just as much as everyone else's."
    };
    return insights[userType];
}

function getTypicalChallenge(userType) {
    const challenges = {
        1: "the ongoing dialogue between your inner critic and your compassionate self",
        2: "finding the balance between giving to others and receiving what you need",
        3: "staying connected to your authentic self while achieving your goals",
        4: "embracing both the beauty and the ordinary moments of life",
        5: "moving from understanding to action, from thinking to engaging",
        6: "learning to trust your own inner wisdom alongside external guidance",
        7: "developing the capacity to stay present with both joy and sorrow",
        8: "allowing others to see and support your more tender aspects",
        9: "finding your voice and honoring your own priorities"
    };
    return challenges[userType];
}

// Helper functions for more natural responses
function getTypeFocus(type) {
    const focuses = {
        1: "correctness, improvement, and maintaining high standards",
        2: "helping others and building meaningful connections", 
        3: "achieving goals, success, and positive image",
        4: "authenticity, depth, and unique self-expression",
        5: "understanding, competence, and maintaining energy",
        6: "security, loyalty, and anticipating potential problems",
        7: "possibilities, variety, and keeping things positive",
        8: "justice, control, and protecting themselves and others",
        9: "harmony, comfort, and avoiding conflict"
    };
    return focuses[type];
}

function getGrowthDirection(type) {
    const directions = {
        1: "learning to accept 'good enough' and practicing self-compassion",
        2: "focusing on your own needs and developing healthy boundaries",
        3: "slowing down to connect with your authentic feelings and values",
        4: "engaging with the present moment and taking practical action",
        5: "stepping into action and sharing your knowledge with others",
        6: "trusting your own judgment and taking confident action",
        7: "developing depth and staying present with difficult emotions",
        8: "practicing vulnerability and considering others' perspectives",
        9: "speaking up for your priorities and taking initiative"
    };
    return directions[type];
}

function getStressPattern(type) {
    const patterns = {
        1: "become more critical and rigid, feeling like everything is wrong",
        2: "become demanding and manipulative when feeling unappreciated",
        3: "become deceptive and cut corners to maintain your image",
        4: "withdraw into depression and become overly dramatic",
        5: "become more isolated and may act out impulsively",
        6: "become reactive and either overly compliant or rebellious",
        7: "become scattered and may act out destructively",
        8: "become more aggressive and controlling",
        9: "become stubborn and passive-aggressive"
    };
    return patterns[type];
}

function getStressAdvice(type) {
    const advice = {
        1: "Try to practice acceptance and remember that perfection isn't always necessary. Take breaks and be gentle with yourself.",
        2: "Focus on your own needs first. It's not selfish - you can't pour from an empty cup.",
        3: "Slow down and check in with your real feelings. Your worth isn't just in what you achieve.",
        4: "Engage with the world around you. Sometimes action, even small steps, can shift your emotional state.",
        5: "Don't isolate completely. Reach out to trusted people and share what you're experiencing.",
        6: "Ground yourself in facts rather than worst-case scenarios. Trust your own judgment.",
        7: "Stay present with the difficult feelings instead of moving away from them. They'll pass.",
        8: "Practice vulnerability. Let trusted people help you carry the load.",
        9: "Speak up about what you need. Your voice and preferences matter."
    };
    return advice[type];
}

function getTypeSpecificInsight(type, message) {
    // This could be more sophisticated, but for now, return general insights
    const insights = {
        1: "Your attention to detail and high standards are gifts, even when they feel burdensome.",
        2: "Your ability to understand and care for others is remarkable - just remember you matter too.",
        3: "Your drive and adaptability help you achieve amazing things. The key is staying connected to what truly matters to you.",
        4: "Your emotional depth and creativity bring beauty and authenticity to everything you touch.",
        5: "Your thoughtful analysis and unique perspective offer valuable insights others often miss.",
        6: "Your loyalty and ability to anticipate problems make you an invaluable friend and team member.",
        7: "Your optimism and enthusiasm bring joy and possibility to any situation.",
        8: "Your strength and directness help you protect others and create positive change in the world.",
        9: "Your ability to see all sides and create harmony is a rare and precious gift."
    };
    return insights[type];
}

        function handleRelationshipQuestion(message, userType) {
            const relationshipDynamics = {
                "1-3": {
                    synergies: "You both value improvement and getting things done. Type 1's principles can ground Type 3's ambition, while Type 3's adaptability can help Type 1 be more flexible.",
                    challenges: "Type 1 may see Type 3 as cutting corners or being inauthentic, while Type 3 may find Type 1 too rigid or critical of their methods.",
                    advice: "Type 1: Appreciate your partner's drive and results. Type 3: Value your partner's integrity and depth over quick wins."
                },
                "1-2": {
                    synergies: "Both want to help and improve the world. You share strong values and a desire to do good.",
                    challenges: "Type 1's criticism may hurt Type 2's feelings, while Type 2's emotional needs may feel overwhelming to Type 1.",
                    advice: "Focus on your shared values. Type 1: express appreciation more. Type 2: give space for processing."
                },
                "2-3": {
                    synergies: "Both are people-focused and adaptive. Type 2's warmth supports Type 3's goals, while Type 3's success makes Type 2 feel proud.",
                    challenges: "Both may lose touch with their own needs while focusing on image or others. Authenticity can be challenging.",
                    advice: "Create regular check-ins about your real feelings and needs, not just what looks good or helps others."
                },
                "3-4": {
                    synergies: "Type 3 brings optimism and energy, while Type 4 brings depth and authenticity. You can balance achievement with meaning.",
                    challenges: "Type 3 may find Type 4 too moody or negative, while Type 4 may see Type 3 as superficial or disconnected from feelings.",
                    advice: "Type 3: slow down to appreciate emotional depth. Type 4: recognize that action and feelings can coexist."
                },
                "3-5": {
                    synergies: "Type 3's energy and Type 5's expertise make a powerful combination. You can achieve meaningful goals together.",
                    challenges: "Type 3 may feel Type 5 is too withdrawn or slow, while Type 5 may find Type 3 too demanding of time and energy.",
                    advice: "Type 3: respect your partner's need for solitude and reflection. Type 5: share your insights and engage with your partner's world."
                },
                "4-5": {
                    synergies: "Both value depth, authenticity, and understanding. You can create a rich inner world together.",
                    challenges: "Both may withdraw when stressed, leading to isolation. Emotional intensity may be overwhelming.",
                    advice: "Practice staying connected during difficult times. Take turns being the one who reaches out."
                },
                "5-6": {
                    synergies: "Both are thoughtful and loyal. You can build a secure, understanding partnership based on trust.",
                    challenges: "Both may be anxious or overthink. Type 6 may need more reassurance than Type 5 naturally gives.",
                    advice: "Type 5: offer more verbal reassurance. Type 6: trust your partner's commitment even when they're quiet."
                },
                "6-7": {
                    synergies: "Type 6's loyalty grounds Type 7's enthusiasm, while Type 7's optimism helps Type 6 worry less.",
                    challenges: "Type 6 may find Type 7 unreliable or avoiding problems, while Type 7 may feel constrained by Type 6's anxiety.",
                    advice: "Type 6: trust your partner's positive intentions. Type 7: show up consistently for important matters."
                },
                "7-8": {
                    synergies: "Both are energetic and action-oriented. You can tackle big goals and have adventures together.",
                    challenges: "Both may avoid vulnerability. Type 8 may be too intense for Type 7, while Type 7 may seem superficial to Type 8.",
                    advice: "Create space for both lightness and depth. Practice sharing feelings, not just ideas and plans."
                },
                "8-9": {
                    synergies: "Type 8's energy motivates Type 9, while Type 9's calm balances Type 8's intensity.",
                    challenges: "Type 8 may become frustrated with Type 9's pace, while Type 9 may feel overwhelmed by Type 8's intensity.",
                    advice: "Type 8: practice patience and gentleness. Type 9: speak up about your needs and preferences."
                },
                "1-9": {
                    synergies: "Type 1's structure helps Type 9 get organized, while Type 9's calm helps Type 1 relax their standards.",
                    challenges: "Type 1 may become frustrated with Type 9's procrastination, while Type 9 may feel criticized or pressured.",
                    advice: "Type 1: focus on acceptance over correction. Type 9: communicate your needs clearly rather than withdrawing."
                }
            };

            if (message.includes('type 3') || message.includes(' 3')) {
                const dynamics = relationshipDynamics[`${userType}-3`] || relationshipDynamics[`3-${userType}`];
                if (dynamics) {
                    return `Great question about Type ${userType} and Type 3 relationships!\n\n**Synergies:** ${dynamics.synergies}\n\n**Potential Challenges:** ${dynamics.challenges}\n\n**Advice:** ${dynamics.advice}`;
                }
            }

            return "Relationships between different Enneagram types can be incredibly rewarding when both people understand each other's motivations. What specific aspect of your relationship dynamic would you like to explore?";
        }

        function handleTypeComparisonQuestion(userType, otherType, message) {
            const typeDescriptions = {
                1: "principled, organized, and improvement-focused",
                2: "caring, helpful, and relationship-oriented", 
                3: "ambitious, adaptable, and success-oriented",
                4: "authentic, creative, and emotionally deep",
                5: "perceptive, independent, and knowledge-seeking",
                6: "loyal, responsible, and security-oriented",
                7: "enthusiastic, versatile, and possibility-focused",
                8: "confident, decisive, and justice-oriented",
                9: "peaceful, easygoing, and harmony-seeking"
            };

            return `Working with a Type ${otherType} when you're a Type ${userType} can be really interesting! Type ${otherType}s are typically ${typeDescriptions[otherType]}, while you as a Type ${userType} are ${typeDescriptions[userType]}. The key is understanding what motivates each of you. What specific situation are you trying to navigate together?`;
        }

        function handleWorkQuestion(message, userType) {
            const workAdvice = {
                1: "Focus on shared standards and clear expectations. Appreciate different approaches to quality results.",
                2: "Remember that not everyone shows care the same way. Focus on the work relationship, not personal connection.",
                3: "Recognize that not everyone is motivated by achievement. Adapt your communication style to their values.",
                4: "Appreciate that others may not need the same emotional depth. Focus on the task while honoring authenticity.",
                5: "Share your expertise when asked, but don't expect others to need as much information before acting.",
                6: "Build trust through consistency. Not everyone needs as much security, but everyone appreciates reliability.",
                7: "Remember that others may prefer depth over breadth. Finish commitments before starting new projects.",
                8: "Use your natural leadership while being mindful of others' need for autonomy and gentler communication.",
                9: "Your diplomatic skills are valuable. Practice speaking up about your priorities and preferences."
            };

            return `${workAdvice[userType]} What specific work challenge are you facing with this person?`;
        }

        function handleGrowthQuestion(message, userType) {
            const growthAdvice = {
                1: "Start small and focus on progress over perfection. Set 'good enough' standards for some areas of life.",
                2: "Practice asking for what you need directly. Schedule self-care like you would any other important appointment.",
                3: "Try activities purely for enjoyment, not achievement. Practice being instead of doing.",
                4: "Focus on what you have rather than what's missing. Engage with the world around you, not just your inner world.",
                5: "Set small, specific action goals. Remember that energy often comes from engagement, not just conservation.",
                6: "Practice trusting your own judgment. Take small risks to build confidence in your decision-making.",
                7: "Choose depth over breadth in some areas. Practice staying with difficult feelings instead of moving away from them.",
                8: "Practice vulnerability and asking for help. Use your energy to build up rather than just protect.",
                9: "Start with tiny actions toward your priorities. Use external structure and accountability to get moving."
            };

            if (message.includes('active') || message.includes('motivation') || message.includes('energy')) {
                const typeSpecific = {
                    1: "Channel your improvement drive into physical activity. Set structured, achievable fitness goals.",
                    2: "Find active ways to connect with others - group fitness, walking meetings, or family activities.",
                    3: "Set fitness goals you can track and achieve. Competition or visible progress will motivate you.",
                    4: "Choose activities that feel meaningful or aesthetic - dance, yoga, hiking in beautiful places.",
                    5: "Start with solo activities that don't drain your social energy. Research the most efficient approaches.",
                    6: "Find activities with a community or buddy system for accountability and security.",
                    7: "Try variety! Mix different activities to keep it interesting and avoid boredom.",
                    8: "Choose intense, challenging activities. Competition or physical challenges will energize you.",
                    9: "Start incredibly small - a 5-minute walk. Build routine gradually and get external accountability."
                };
                return typeSpecific[userType];
            }

            return growthAdvice[userType];
        }

        function handleDirectQuestion(message, userType) {
            // Handle specific questions that expect direct answers
            if (message.includes('trouble spots') || message.includes('challenges')) {
                return `The main relationship challenges for your type combination typically involve: communication style differences, different priorities and values, and how you each handle stress. Would you like me to elaborate on any of these areas?`;
            }
            
            if (message.includes('answer') && message.includes('question')) {
                return `You're absolutely right - I should give you direct answers! I'm here to provide specific insights about Enneagram types and relationships. What would you like to know?`;
            }

            return `That's a great specific question. Based on your Type ${userType} perspective, what aspect of this situation feels most challenging for you right now?`;
        }

        function getTypeSpecificResponse(message, userType) {
            const specificResponses = {
                1: "Your attention to detail and high standards are strengths. What situation is triggering your inner critic right now?",
                2: "Your caring nature is a gift. Are you remembering to take care of your own needs too?",
                3: "Your drive and adaptability are impressive. What does authentic success look like for you personally?",
                4: "Your emotional depth and authenticity matter. What's stirring up your feelings today?",
                5: "Your analytical perspective is valuable. What are you trying to understand or figure out?",
                6: "Your loyalty and careful thinking serve you well. What's making you feel uncertain right now?",
                7: "Your enthusiasm and optimism are contagious. What new possibility is exciting you?",
                8: "Your strength and directness are needed in this world. How can you use your power constructively here?",
                9: "Your peaceful presence is a gift to others. What's most important to you in this situation?"
            };

            return specificResponses[userType] || "I'd love to help you explore this further. Can you tell me more about what's on your mind?";
        }

        // Add these NEW functions before the closing </script> tag

function detectEmotionalTone(message) {
    const lowerMessage = message.toLowerCase();
    
    if (lowerMessage.includes('frustrated') || lowerMessage.includes('angry') || lowerMessage.includes('annoying') || lowerMessage.includes('irritated')) {
        return 'frustrated';
    }
    if (lowerMessage.includes('sad') || lowerMessage.includes('depressed') || lowerMessage.includes('down') || lowerMessage.includes('overwhelmed')) {
        return 'sad';
    }
    if (lowerMessage.includes('excited') || lowerMessage.includes('amazing') || lowerMessage.includes('great') || lowerMessage.includes('wonderful')) {
        return 'positive';
    }
    if (lowerMessage.includes('confused') || lowerMessage.includes('help') || lowerMessage.includes('understand') || lowerMessage.includes('how do i')) {
        return 'seeking';
    }
    return 'neutral';
}

function getResponseDepth() {
    if (conversationHistory.length < 4) return 'surface';
    if (conversationHistory.length < 8) return 'moderate';
    return 'deep';
}

function getScenarioExample(userType, theme) {
    const scenarios = {
        1: {
            work: "Like when a colleague submits work that's 'good enough' but you can see five ways to improve it",
            relationships: "When your partner leaves dishes in the sink and you're torn between saying something or just doing it yourself",
            general: "When you notice errors everywhere but wonder if pointing them out makes you seem critical"
        },
        2: {
            work: "When you're helping everyone else with their projects but falling behind on your own deadlines",
            relationships: "When you sense someone's upset but they say 'I'm fine' and you're not sure whether to push or give space",
            general: "When you've been giving so much that you're exhausted but feel guilty saying no"
        },
        3: {
            work: "When you're crushing your goals but wondering if you're becoming someone you don't recognize",
            relationships: "When you catch yourself adapting your personality to what you think others want to see",
            general: "When success feels hollow because you're not sure it reflects who you really are"
        },
        4: {
            work: "When you're surrounded by people but feel like nobody really 'gets' you",
            relationships: "When you're envious of what others have but also judgmental about their 'ordinary' choices",
            general: "When you feel like you're missing some essential piece that everyone else has"
        },
        5: {
            work: "When meetings drain your energy and you need three hours alone just to recover",
            relationships: "When someone wants emotional support but you don't know what to say or do",
            general: "When you understand something deeply but struggle to explain it to others"
        },
        6: {
            work: "When you've thought through every possible problem but your team thinks you're being negative",
            relationships: "When you need reassurance but don't want to seem needy or insecure",
            general: "When you can't tell if your worry is realistic preparation or just anxiety"
        },
        7: {
            work: "When you have ten exciting projects but struggle to focus deeply on any of them",
            relationships: "When conflict arises and your instinct is to change the subject or make a joke",
            general: "When you feel restless in routine but know some things require sustained effort"
        },
        8: {
            work: "When you see injustice and want to fight it but worry about coming across as aggressive",
            relationships: "When you care deeply but struggle to show your tender feelings",
            general: "When you want to protect others but they see your intensity as intimidating"
        },
        9: {
            work: "When you have strong opinions but stay quiet to keep the peace",
            relationships: "When you merge so much with others' needs that you lose track of your own",
            general: "When you know what you want but can't seem to take action on your priorities"
        }
    };
    return scenarios[userType]?.[theme] || scenarios[userType]?.general || null;
}

function getIntegrationDirection(userType) {
    const directions = {
        1: "When you're growing, you move toward Type 7's spontaneity and joy - allowing yourself to be more flexible and playful",
        2: "When you're growing, you move toward Type 4's self-awareness and authenticity - getting in touch with your own feelings and needs",
        3: "When you're growing, you move toward Type 6's loyalty and commitment to others - focusing on relationships over just achievements",
        4: "When you're growing, you move toward Type 1's objectivity and principled action - taking concrete steps toward your ideals",
        5: "When you're growing, you move toward Type 8's confident action and leadership - stepping into your power and taking charge",
        6: "When you're growing, you move toward Type 9's calm and trusting presence - relaxing into confidence and inner peace",
        7: "When you're growing, you move toward Type 5's focus and depth - developing the ability to go deep rather than wide",
        8: "When you're growing, you move toward Type 2's care and consideration for others - showing your nurturing side",
        9: "When you're growing, you move toward Type 3's focus and decisive action - taking initiative on what matters to you"
    };
    return directions[userType];
}

function getConversationStarters(userType) {
    const starters = {
        1: ["How do you handle it when others don't meet your standards?", "What does 'good enough' mean to you?", "When do you feel most at peace with imperfection?"],
        2: ["How do you know when you're giving too much?", "What do you do when you need help but don't want to ask?", "When do you feel most cared for by others?"],
        3: ["How do you stay connected to what truly matters to you?", "When do you feel most authentic?", "What does success mean to you personally, not professionally?"],
        4: ["How do you find meaning in ordinary moments?", "What helps when you feel misunderstood?", "When do you feel most connected to others?"],
        5: ["How do you balance understanding with taking action?", "When do you feel most energized?", "What draws you out of your shell?"],
        6: ["How do you distinguish between realistic and anxious thoughts?", "When do you trust your own judgment?", "What makes you feel most secure?"],
        7: ["How do you stay present with difficult emotions?", "What gives your life real depth?", "When do you feel most grounded?"],
        8: ["How do you show your softer side safely?", "When has vulnerability actually increased your power?", "What makes you feel most understood?"],
        9: ["How do you speak up for what matters to you?", "When do you feel most motivated to take action?", "What helps you connect with your own priorities?"]
    };
    return starters[userType] || [];
}

// More robust loading handler
function hideLoadingScreen() {
    const loadingScreen = document.getElementById('loadingScreen');
    if (loadingScreen) {
        loadingScreen.style.display = 'none';
    }
}

// Try multiple approaches to ensure loading screen gets hidden
if (document.readyState === 'complete') {
    // Page already loaded
    hideLoadingScreen();
} else {
    // Wait for page load
    window.addEventListener('load', hideLoadingScreen);
    
    // Backup: hide after DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(hideLoadingScreen, 1000);
    });
    
    // Final backup: hide after 3 seconds no matter what
    setTimeout(hideLoadingScreen, 3000);
}
    </script>
</body>
</html>
